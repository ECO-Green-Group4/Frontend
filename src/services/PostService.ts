import api from './axios';

export interface Post {
id?: number;
listingId?: number; // C√≥ th·ªÉ API tr·∫£ v·ªÅ listingId thay v√¨ id
title: string;
content: string;
description?: string;
price: number;
status: 'DRAFT' | 'PENDING' | 'PENDING_APPROVAL' | 'APPROVED' | 'REJECTED' | 'ACTIVE' | 'INACTIVE';
category: 'EV' | 'BATTERY' ;
images?: string[];
userId?: number;
user?: {
  userId?: number;
  id?: number;
  fullName: string;
  email: string;
  username?: string;
  phone?: string | null;
  status?: string;
  dateOfBirth?: string;
  gender?: string;
  identityCard?: string | null;
  address?: string | null;
  createdAt?: string | null;
  availableCoupons?: number | null;
};
createdAt?: string; 
updatedAt?: string;
// Th√¥ng tin chi ti·∫øt t·ª´ API
itemType?: 'vehicle' | 'battery';
location?: string;
postType?: string | null;
listingPackageId?: number | null;
packageAmount?: number | null;
packageStatus?: string | null;
packageExpiredAt?: string | null;
// Vehicle fields
brand?: string | null;
model?: string | null;
year?: number | null;
mileage?: number | null;
condition?: string | null;
bodyType?: string | null;
color?: string | null;
inspection?: string | null;
origin?: string | null;
numberOfSeats?: number | null;
licensePlate?: string | null;
accessories?: string | null;
// Battery fields
batteryCapacity?: number | null;
batteryBrand?: string | null;
voltage?: number | null;
type?: string | null;
capacity?: string | null;
healthPercent?: number | null;
manufactureYear?: number | null;
chargeCycles?: number | null;
}

export interface PostResponse {
message: string;
success: boolean;
data: Post[];
}

export interface CreatePostRequest {
title: string;
content: string;
description?: string;
price: number;
category: 'EV' | 'BATTERY' | 'ACCESSORY';
images?: string[];
}

export interface CreatePostResponse {
message: string;
success: boolean;
data: Post;
}

export interface UpdatePostResponse {
message: string;
success: boolean;
data: Post; // API tr·∫£ v·ªÅ object Post, kh√¥ng ph·∫£i string
}

export interface DeletePostResponse {
message: string;
success: boolean;
data: string;
}

// ƒê·ªãnh nghƒ©a ki·ªÉu status
export type PostStatus = 'DRAFT' | 'PENDING' | 'PENDING_APPROVAL' | 'APPROVED' | 'REJECTED' | 'ACTIVE' | 'INACTIVE';

// === TO√ÄN B·ªò SERVICE OBJECT ƒê√É ƒê∆Ø·ª¢C S·ª¨A L·∫†I ƒê√öNG ===
export const PostService = {
// L·∫•y t·∫•t c·∫£ listings
getAllPosts: async (): Promise<Post[]> => {
try {
console.log('üìã Fetching all listings...');
const response = await api.get<PostResponse>('/admin/listings');
console.log('‚úÖ Listings response:', response.data);
console.log('üìä Total listings:', response.data.data?.length);
if (response.data.data?.length > 0) {
  console.log('üîç First listing sample:', response.data.data[0]);
}
return response.data.data;
} catch (error: any) {
console.error('‚ùå Error fetching listings:', error);
console.error('Error response:', error.response?.data);
console.error('Error status:', error.response?.status);
 throw error;
}
},

// L·∫•y listing theo ID
getPostById: async (postId: number): Promise<Post> => {
try {
console.log('üîç Fetching listing with ID:', postId);
console.log('üì° Request URL:', `/admin/listings/${postId}`);
const response = await api.get<{ message: string; success: boolean; data: Post }>(`/admin/listings/${postId}`);
console.log('‚úÖ Listing response:', response.data);
return response.data.data;
 } catch (error: any) {
console.error('‚ùå Error fetching listing:', error);
console.error('Error response:', error.response?.data);
console.error('Error status:', error.response?.status);
console.error('Error message:', error.message);
throw error;
 }
},

// C·∫≠p nh·∫≠t tr·∫°ng th√°i (S·ª≠a l·ªói 400 - S·ª≠ d·ª•ng query parameter approved)
updatePostStatus: async (postId: number, newStatus: PostStatus): Promise<UpdatePostResponse> => {
  try {
    console.log('üîÑ Updating listing status with ID:', postId, 'New Status:', newStatus);
    
    // Chuy·ªÉn ƒë·ªïi status th√†nh boolean approved
    const approved = newStatus === 'APPROVED' || newStatus === 'ACTIVE';
    
    console.log('üì° Request URL:', `/admin/listings/${postId}/status?approved=${approved}`);

    const response = await api.put<UpdatePostResponse>(
      `/admin/listings/${postId}/status?approved=${approved}`
    );

    console.log('‚úÖ Update status response:', response.data);
    return response.data;
  } catch (error: any) {
    console.error('‚ùå Error updating listing status:', error);
    console.error('Error response:', error.response?.data);
    console.error('Error status:', error.response?.status);
    console.error('Error message:', error.message);
    throw error;
  }
},

// X√≥a listing
deletePost: async (postId: number): Promise<DeletePostResponse> => {
  try {
    console.log('Deleting listing with ID:', postId);
    const response = await api.delete<DeletePostResponse>(`/admin/listings/${postId}`);
    console.log('Delete response:', response.data);
    return response.data;
  } catch (error) {
    console.error('Error deleting listing:', error);
    throw error;
  }
}
};